# StableGuard 测试指南

## 🧪 测试环境准备

### 1. 构建扩展
```bash
npm run build
```

### 2. 加载到 Chrome
1. 打开 Chrome，进入 `chrome://extensions/`
2. 开启"开发者模式"
3. 点击"加载已解压的扩展程序"
4. 选择 `dist` 目录

### 3. 打开开发者工具
- 右键点击扩展图标 → 检查弹出内容（Popup DevTools）
- 右键点击扩展图标 → 管理扩展 → 背景页（Background DevTools）

## 📋 测试清单

### ✅ 基础功能测试

#### 1. StableGuard 初始化
**步骤**：
1. 打开钱包
2. 查看 Background DevTools 控制台

**预期结果**：
```
[StableGuard] Initialized with config: {...}
[StableGuard] Running periodic risk assessment
```

#### 2. 风险数据加载
**步骤**：
1. 打开钱包 Home 页面
2. 查看 StableGuard 徽章

**预期结果**：
- 显示风险等级（绿色/黄色/橙色/红色）
- 显示"StableGuard 安全/良好/注意/警告/高危"

**验证点**：
- [ ] 徽章正常显示
- [ ] 颜色与风险等级匹配
- [ ] 点击可跳转到仪表板

#### 3. 风控仪表板
**步骤**：
1. 点击 Home 页面的 StableGuard 徽章
2. 进入风控仪表板

**预期结果**：
- 显示 USDT、USDC、DAI 的风险卡片
- 每个卡片包含：
  - 风险等级标签
  - 风险评分（0-100）
  - 风险摘要文本
  - 进度条

**验证点**：
- [ ] 所有稳定币卡片正常显示
- [ ] 风险等级颜色正确
- [ ] 评分数值合理（0-100）
- [ ] 最后更新时间显示

#### 4. 手动刷新
**步骤**：
1. 在风控仪表板点击右上角刷新按钮
2. 观察加载状态

**预期结果**：
- 刷新按钮显示旋转动画
- Console 输出：
```
[StableGuard] Starting risk assessment...
[DataAgent] Starting data collection for: ['usdt', 'usdc', 'dai']
[DataAgent] Fetched price for usdt: 1.xxx
[FeatureAgent] Calculating features for 3 stablecoins
[RiskAgent] Analyzing risk for 3 stablecoins
[StrategyAgent] Generating strategies for 3 risk reports
[StableGuard] Assessment completed in XXXms
```

**验证点**：
- [ ] 刷新动画正常
- [ ] 数据更新成功
- [ ] 无错误日志
- [ ] 最后更新时间更新

### ✅ 设置功能测试

#### 5. StableGuard 设置
**步骤**：
1. 进入 Settings → StableGuard 设置
2. 测试启用/禁用开关
3. 测试三种风控模式切换

**预期结果**：
- 开关状态正确切换
- 模式选择高亮显示
- 点击"保存设置"后配置持久化

**验证点**：
- [ ] 启用/禁用开关工作正常
- [ ] 三种模式可正常选择
- [ ] 保存后刷新页面，设置保持
- [ ] 禁用后徽章显示灰色或隐藏

### ✅ 交易风控测试

#### 6. 非稳定币交易（正常流程）
**步骤**：
1. 发起一笔普通 ETH 转账
2. 观察确认页面

**预期结果**：
- 不显示 StableGuard 风险警告
- 交易正常确认

**验证点**：
- [ ] 无风险提示
- [ ] 交易流程不受影响

#### 7. 稳定币交易 - 低风险
**步骤**：
1. 确保 StableGuard 启用
2. 发起一笔 USDT/USDC 转账（需要有测试网代币）
3. 观察确认页面

**预期结果**：
- Background Console 输出：
```
[Background] StableGuard evaluation: allow
```
- 确认页面可能显示绿色风险提示（取决于实际风险）
- 交易可正常确认

**验证点**：
- [ ] StableGuard 评估执行
- [ ] 风险信息正确显示
- [ ] 交易可正常完成

#### 8. 模拟高风险场景（手动测试）
由于实际市场条件难以控制，可以通过修改代码模拟：

**方法 1：修改阈值**
在 `config.ts` 中临时降低阈值：
```typescript
thresholds: {
  priceDeviationWarning: 0.01,  // 0.01% 就警告
  priceDeviationCritical: 0.05, // 0.05% 就严重
  ...
}
```

**方法 2：Mock 数据**
在 `dataAgent.ts` 中临时返回异常价格：
```typescript
return {
  price: 0.95,  // 模拟脱锚
  priceChange24h: -5,
  ...
}
```

**预期结果**：
- 风险等级提升到 D 或 E
- 根据设置：
  - **Warn 模式**：显示黄色/红色警告，要求确认
  - **Block 模式**：直接阻止交易，返回错误

**验证点**：
- [ ] 高风险正确识别
- [ ] 警告信息清晰
- [ ] 阻止模式生效

### ✅ 定时评估测试

#### 9. 定时任务
**步骤**：
1. 打开 Background DevTools
2. 等待 5 分钟
3. 观察 Console 输出

**预期结果**：
每 5 分钟输出：
```
[StableGuard] Running periodic risk assessment
[StableGuard] Assessment completed: 3 stablecoins
```

**验证点**：
- [ ] 定时任务正常执行
- [ ] 评估成功完成
- [ ] 无错误日志

#### 10. 高风险通知
**步骤**：
1. 模拟高风险场景（见测试 8）
2. 等待定时评估触发
3. 查看系统通知

**预期结果**：
- 收到 Chrome 通知
- 通知内容："检测到 X 个稳定币存在高风险，请查看详情。"

**验证点**：
- [ ] 通知正常弹出
- [ ] 通知内容正确
- [ ] 点击通知可打开钱包

### ✅ 数据持久化测试

#### 11. 配置持久化
**步骤**：
1. 修改 StableGuard 设置
2. 关闭钱包
3. 重新打开钱包
4. 检查设置

**预期结果**：
- 设置保持不变

**验证点**：
- [ ] 启用状态保持
- [ ] 风控模式保持
- [ ] 无需重新配置

#### 12. 评估结果缓存
**步骤**：
1. 执行一次风险评估
2. 关闭钱包
3. 立即重新打开
4. 查看仪表板

**预期结果**：
- 立即显示上次评估结果
- 显示"X 分钟前"更新时间

**验证点**：
- [ ] 缓存数据正常加载
- [ ] 更新时间正确
- [ ] 无需等待重新评估

### ✅ 错误处理测试

#### 13. API 失败处理
**步骤**：
1. 断开网络连接
2. 点击刷新按钮
3. 观察错误提示

**预期结果**：
- 显示错误提示："刷新失败: ..."
- 使用缓存数据（如果有）
- 不影响钱包其他功能

**验证点**：
- [ ] 错误提示友好
- [ ] 不崩溃
- [ ] 可重试

#### 14. 无数据状态
**步骤**：
1. 清除 Chrome Storage（chrome://extensions/ → 扩展详情 → 清除数据）
2. 打开风控仪表板

**预期结果**：
- 显示"暂无风险数据"
- 显示"立即评估"按钮

**验证点**：
- [ ] 空状态 UI 正常
- [ ] 可触发首次评估

## 🐛 已知问题与限制

### 当前限制
1. **MVP 阶段**：
   - 链上数据采集未实现（大额转账监控）
   - 舆情数据未实现
   - 制度数据未实现
   - RAG 后端未集成

2. **API 限制**：
   - CoinGecko 免费版：50 次/分钟
   - 价格数据可能有 1-2 分钟延迟

3. **测试网络**：
   - 测试网上稳定币价格可能不准确
   - 建议在主网环境测试（小额）

### 常见问题

**Q: 风险评估一直显示"加载中"？**
A: 检查网络连接，查看 Console 是否有 API 错误。

**Q: 所有稳定币都显示极低风险？**
A: 正常情况下，稳定币应该保持低风险。可以通过修改代码模拟高风险场景。

**Q: 交易确认页面没有风险提示？**
A: 检查：
1. StableGuard 是否启用
2. 交易是否涉及稳定币合约
3. Console 是否有评估日志

**Q: 定时评估不执行？**
A: Chrome 扩展的 Service Worker 可能被挂起，重新加载扩展即可。

## 📊 测试报告模板

```markdown
## StableGuard 测试报告

**测试日期**：YYYY-MM-DD
**测试人员**：XXX
**版本**：v1.0.0

### 测试环境
- Chrome 版本：XXX
- 操作系统：XXX
- 网络状态：正常/受限

### 测试结果

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 基础初始化 | ✅ | - |
| 风险数据加载 | ✅ | - |
| 风控仪表板 | ✅ | - |
| 手动刷新 | ✅ | - |
| 设置功能 | ✅ | - |
| 非稳定币交易 | ✅ | - |
| 稳定币交易 | ✅ | - |
| 高风险场景 | ⚠️ | 需要模拟数据 |
| 定时评估 | ✅ | - |
| 高风险通知 | ⚠️ | 需要模拟数据 |
| 配置持久化 | ✅ | - |
| 评估结果缓存 | ✅ | - |
| API 失败处理 | ✅ | - |
| 无数据状态 | ✅ | - |

### 发现的问题
1. [问题描述]
2. [问题描述]

### 改进建议
1. [建议内容]
2. [建议内容]
```

## 🚀 下一步

完成测试后，可以：
1. 提交测试报告
2. 修复发现的问题
3. 优化用户体验
4. 准备生产部署

---

**祝测试顺利！** 🎉
